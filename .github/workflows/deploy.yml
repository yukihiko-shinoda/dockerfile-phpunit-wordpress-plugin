on:
  push:
    tags:
      - 'v[0-9][0-9][0-9][0-9][01][0-9][0-3][0-9][0-2][0-9][0-5][0-9][0-5][0-9]'
jobs:
  # - How to share matrix between jobs · community · Discussion #26284
  #   https://github.com/orgs/community/discussions/26284#discussioncomment-3251198
  matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v5
      - id: set-matrix
        run: |
          TASKS=$(echo $(cat software-versions.json) | sed 's/ //g' )
          echo "matrix=$TASKS" >> $GITHUB_OUTPUT
  deploy:
    needs: [ matrix ]
    strategy:
      fail-fast: false
      matrix:
        software-versions: ${{ fromJson(needs.matrix.outputs.matrix) }}
    env:
      PHP_IMAGE_TAG: ${{ matrix.software-versions[0] }}
      SCAFFOLD_COMMAND_VERSION: ${{ matrix.software-versions[1] }}
      WORDPRESS_VERSION: ${{ matrix.software-versions[2] }}
      PHP_UNIT_VERSION: ${{ matrix.software-versions[3] }}
      MYSQL_VERSION: ${{ matrix.software-versions[4] }}
      #Since the image: futureys/ssl-certificate:2.0.2 only supports sud-domain.
      DOMAIN_NAME: futureys.net
    runs-on: ubuntu-latest
    steps:
      - uses: docker/setup-qemu-action@v3
      - id: buildx
        uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}
      - id: extract-tag
        run: echo "DOCKER_TAG=$(echo ${GITHUB_REF#refs/tags/v})" >> $GITHUB_ENV
      - uses: docker/bake-action@v6
        with:
          push: true
          builder: ${{ steps.buildx.outputs.name }}
          targets: app-release
